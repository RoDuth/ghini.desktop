## vim:set ft=mako:
## This file is part of ghini.desktop.
##
## ghini.desktop is free software: you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation, either version 3 of the License, or
## (at your option) any later version.
##
## ghini.desktop is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with ghini.desktop. If not, see <http://www.gnu.org/licenses/>.
##
<%!
from bauble.plugins.report import get_species_pertinent_to
import re
%>\
Generic Hybrid Symbol,Genus,Specific Hybrid Symbol,Species,Infraspecific Rank,Infraspecific Epithet,Secondary Infraspecific Rank,Secondary Infraspecific Epithet,Cultivar,Grex,Author,Hybrid Formula Symbol,Hybrid Genus,Hybrid Species,Hybrid Infraspecific Rank,Hybrid Infraspecific Epithet,Hybrid Secondary Infraspecific Rank,Hybrid Secondary Infraspecific Epithet
% for sp in get_species_pertinent_to(values):
<%
  hybrid_gen_symb = sp.genus.hybrid or ''
  genus = sp.genus.epithet
  hybrid_sp_symb = sp.hybrid or ''
  cv = (sp.cultivar_epithet or sp.trade_name or '').replace("`", "'")
  epithet = sp.epithet or ''
  hybrid_epithet = ""
  hybrid_genus = ""
  hybrid_form = ""
  if '×' in epithet:
    epithet = ""
    if not cv:
      match = re.match("^([a-z-]+) × ([a-z-]+)$", sp.epithet)
      # species hybrids (not named cultivars)
      if match:
        epithet = match.groups()[0]
        hybrid_epithet = match.groups()[1]
        hybrid_genus = sp.genus
        hybrid_form = '×'

      # TODO how about hybrids of Infraspecific parts etc.?

  infra1_rank = sp.infrasp1_rank or ''
  infra1 = sp.infrasp1 or ''
  infra2_rank = sp.infrasp2_rank or ''
  infra2 = sp.infrasp2 or ''
  grex = sp.grex or ""
  author = sp.infrasp2_author or sp.infrasp1_author or sp.sp_author or ""
  if epithet == infra1:
    # remove authorship for autonyms
    author = ""
%>\
"${hybrid_gen_symb}","${genus}","${hybrid_sp_symb}","${epithet}","${infra1_rank}","${infra1}","${infra2_rank}","${infra2}","${cv}","${grex}","${author}","${hybrid_form}","${hybrid_genus}","${hybrid_epithet}",,,,
% endfor
